<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>이벤트 등록</title>
    <link rel="stylesheet" href="/css/main.css" type="text/css"/>
    <link rel="shortcut icon" href="/images/faviconWhite.ico">
    <link rel="icon" href="/images/faviconWhite.ico">
    <style>
        @font-face {
            font-family: 'S-CoreDream-3Light';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-3Light.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'S-CoreDream-4Regular';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-3Light.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'yg-jalnan';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_four@1.2/JalnanOTF00.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        /* Button */

        input[type="button"],
        input[type="submit"],
        input[type="reset"],
        button,
        .button {
            -webkit-appearance: none;
            display: inline-block;
            text-decoration: none;
            cursor: pointer;
            border: 0;
            border-radius: 5px;
            background: #14a876;
            color: #fff !important;
            font-weight: 700;
            outline: 0;
            font-size: 1.1em;
            padding: 0.65em 1.5em 0.65em 1.5em;
            text-align: center;
            -moz-transition: background-color .25s ease-in-out;
            -webkit-transition: background-color .25s ease-in-out;
            -ms-transition: background-color .25s ease-in-out;
            transition: background-color .25s ease-in-out;
        }

        input[type="button"]:hover,
        input[type="submit"]:hover,
        input[type="reset"]:hover,
        button:hover,
        .button:hover {
            background: #24b886;
        }

        input[type="button"]:active,
        input[type="submit"]:active,
        input[type="reset"]:active,
        button:active,
        .button:active {
            background: #049866;
        }

        input[type="button"].alt,
        input[type="submit"].alt,
        input[type="reset"].alt,
        button.alt,
        .button.alt {
            background: #0b871e;
        }

        input[type="button"].alt:hover,
        input[type="submit"].alt:hover,
        input[type="reset"].alt:hover,
        button.alt:hover,
        .button.alt:hover {
            background: #066514;
        }

        input[type="button"].alt:active,
        input[type="submit"].alt:active,
        input[type="reset"].alt:active,
        button.alt:active,
        .button.alt:active {
            background: #151112;
        }

        input[type="button"].icon:before,
        input[type="submit"].icon:before,
        input[type="reset"].icon:before,
        button.icon:before,
        .button.icon:before {
            opacity: 0.35;
            position: relative;
            top: 0.05em;
            margin-right: 0.75em;
        }

        input[type="button"].large,
        input[type="submit"].large,
        input[type="reset"].large,
        button.large,
        .button.large {
            font-size: 1.5em;
            padding: 0.75em 1.5em 0.75em 1.5em;
        }

        input[type="button"].large,
        input[type="submit"].large,
        input[type="reset"].large,
        button.large,
        .button.large {
            font-size: 1.1em;
            padding: 0.65em 1.5em 0.65em 1.5em;
        }

        .out {
            width: 400px;
            height: 550px;
            margin: 10px;
            padding: 10px;
            border: none;
        }

        .line {
            border: solid 1px #dddddd;
            border-radius: 5px;
        }

        p{
            color:#5d5d5d;
        }

        .headTitle {
            text-align:center;
            margin-bottom: 40px;
        }

        .writePopUp {
            font-family: 'S-CoreDream-4Regular';
        }

        #write span {
            width: 18%;
            line-height: 50px;
            font-size: 12pt;
            font-weight: 700;
        }

        #write input {
            height:50px;
            width: 82%;
        }

        .inputline {
            display: flex;
            margin-bottom: 20px;
        }

        .clickButton {
            width: auto !important;
            line-height: 1.5em;
            background: #94C477 !important;
        }

        .clickButton:hover {
            background: #5d5d5d !important;
        }

        #content {
            width:100%;
            height:250px;
            resize: none;
        }

    </style>
</head>

<body>
<div class="writePopUp" style="margin: 30px 50px;">
    <!--제목-->
    <div>
        <h3 class="headTitle">이벤트 등록하기</h3>
    </div>

    <!--폼 태그-->
    <form action="/event/eventWrite" name="eventForm" id="write" method="post">
        <div class="inputline">
            <span>이벤트명</span>
            <input class="line" name="eventTitle" type="text" placeholder="이벤트 행사이름"/>
        </div>
        <div class="inputline">
            <span>한줄요약</span>
            <input class="line" name="eventSubtitle" type="text" placeholder="이벤트 설명"/>
        </div>
        <div class="inputline">
            <span>신청일자</span>
            <input class="line" name="eventDate" type="text" placeholder="신청 가능한 일자"/>
        </div>
        <span>내용</span>
        <textarea id="content" name="eventContent" class="line" type="text"></textarea>

        <!--첨부파일-->
        <div class="field">
            <span>첨부파일</span>
            <input type="file" name="uploadFiles" multiple>
        </div>
        <br>

        <!--버튼-->
        <div style="text-align: center;">
            <input type="button" class="clickButton" value="등록" onclick="goEventWrite()">
            <span style="padding:1px"></span>
            <input type="button" class="clickButton" value="취소" onclick="close()">
        </div>

        <input type="text" id="img" name="img" style="display: none;">
    </form>
</div>
</body>
<script src="/js/jquery.min.js"></script>
<script th:inline="javascript">
    let eventForm = $(document.eventForm);

    function goEventWrite(){
        eventForm.submit();
    }

    function close(){
        window.close();
    }


    //########################################첨부파일#########################################
    let check = false;
    function showImage(fileCallPath){
        if(check) {return;}
        $(".bigPictureWrapper").css("display", "flex").show();
        $(".bigPicture").html("<img src='/eventupload/display?fileName=" + encodeURIComponent(fileCallPath) + "'>")
            .animate({width:"100%", height:"100%"}, 1000);
        check = true;
        console.log(encodeURIComponent(fileCallPath));
    }

    $(".bigPictureWrapper").on("click", function(){
        if(!check){return;}
        $(".bigPicture").animate({width: "0%", height: "0%"}, 1000);
        setTimeout(function(){
            check = false;
            $(".bigPictureWrapper").hide();
        }, 1000)
    });

    $(document).ready(function() {
        let regex = new RegExp("(.*?)\.(exe|sh|zip|alz)$");
        let maxSize = 5242880;// 5MB
        let inputFile = $(".uploadDiv input");
        let uploadResult = $(".uploadResult ul");

        //form태그에 input hidden 생성 실습
        //서버 쪽으로 전달할 첨부파일의 데이터를 input type hidden으로 추가하기
        //추가된 li태그를 모두 가져와서 data속성을 통해 알맞는 값을 설정한다.
        //form.append("추가할 HTML") : HTML 추가
        //submit을 눌렀을 때 click 이벤트를 발생하고, 기존 submit이벤트는 막아줘야 한다.
        //input태그가 모두 추가된 후 submit()해준다.

        $("input[type='submit']").on("click", function (e) {
            e.preventDefault();
            let form = $("form#registForm");
            let str = "";
            $(".uploadResult ul li").each(function (i, obj) {
                str += "<input type='hidden' name='attachList[" + i + "].fileName' value='" + $(obj).data('name') + "'>"
                str += "<input type='hidden' name='attachList[" + i + "].uuid' value='" + $(obj).data('uuid') + "'>"
                str += "<input type='hidden' name='attachList[" + i + "].uploadPath' value='" + $(obj).data('path') + "'>"
                str += "<input type='hidden' name='attachList[" + i + "].image' value='" + $(obj).data('type') + "'>"
            });
            form.append(str).submit();
        })

        function showUploadFile(uploadFiles) {
            let str = "";
            $(uploadFiles).each(function (i, obj) {
                if (!obj.image) {
                    let fileCallPath = encodeURIComponent(obj.uploadPath + "/" + obj.fileName);
                    str += "<li data-path='" + obj.uploadPath + "' data-uuid='" + obj.uuid + "' data-name='" + obj.fileName.substring(obj.fileName.indexOf("_") + 1) + "' data-type='" + obj.image + "'>";
                    str += "<div>";
                    str += "<a href='/eventupload/download?fileName=" + fileCallPath + "'>";
                    str += "<img src='/img/attach.png' width='100px'>" + obj.fileName.substring(obj.fileName.indexOf("_") + 1);
                    str += "</a>"
                    str += "<span data-file='" + fileCallPath + "' data-type='file'>x</span>";
                    str += "</div>";
                    str += "</li>";
                } else {
                    let fileCallPath = encodeURIComponent(obj.uploadPath + "/s_" + obj.fileName);
                    let originPath = encodeURIComponent(obj.uploadPath + "/" + obj.fileName);

                    str += "<li data-path='" + obj.uploadPath + "' data-uuid='" + obj.uuid + "' data-name='" + obj.fileName.substring(obj.fileName.indexOf("_") + 1) + "' data-type='" + obj.image + "'>";
                    str += "<div>";
                    str += "<a href=\"javascript:showImage(\'" + originPath + "\')\">";
                    str += "<img src='/eventupload/display?fileName=" + fileCallPath + "'>" + obj.fileName.substring(obj.fileName.indexOf("_") + 1);
                    str += "</a>";
                    str += "<span data-file='" + fileCallPath + "' data-type='image'>x</span>";
                    str += "</div>";
                    str += "</li>";
                }
            });
            uploadResult.append(str);
        }

        $(".uploadResult").on("click", "span", function () {
            let targetFile = $(this).data("file");
            let type = $(this).data("type");
            let li = $(this).parents("li");

            $.ajax({
                url: "/eventupload/deleteFile",
                type: "POST",
                data: {fileName: targetFile, type: type},
                dataType: "text",
                success: function (result) {
                    alert(result);
                    li.remove();
                }
            });

        });

        //확장자 별 업로드 제한, 특정 크기 이상의 파일은 업로드 제한
        function checkExtension(fileName, fileSize) {
            if (regex.test(fileName)) {
                alert("업로드 할 수 없는 파일의 형식입니다.");
                return false;
            }
            if (fileSize >= maxSize) {
                alert("파일 사이즈 초과");
                return false;
            }
            return true;
        }

        $("input[type='file']").change(function () {
            let formData = new FormData();
            let inputFile = $("input[name='uploadFiles']");
            let files = inputFile[0].files;

            for (let i = 0; i < files.length; i++) {
                if (!checkExtension(files[i].name, files[i].size)) {
                    return;
                }
                formData.append("uploadFiles", files[i]);
            }

            $.ajax({
                url: "/eventupload/uploadAjaxAction",
                type: "post",
                data: formData,
                contentType: false,
                processData: false,
                success: function (fileList) {
                    showUploadFile(fileList);
                    inputFile.val("");
                }
            });
        });
    });

</script>
</html>