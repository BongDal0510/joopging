<!DOCTYPE HTML>
<!--
	사용자가 게시글 읽기에서 신고하기 버튼을 누르면 팝업으로 창을 띄워
	팝업을 띄운 게시글을 신고 할 수 있도록 한다.

	commuService.readCommu(commuBno)로 게시글 정보를 가져온다.
-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Board</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/community.css" />
    <link rel="shortcut icon" href="/images/faviconWhite.ico">
    <link rel="icon" href="/images/faviconWhite.ico">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding:wght@700&display=swap" rel="stylesheet">

    <style>
        #boardTitleArea{
            border: solid 1.5px #f4f4f5;
            padding: 2%;
        }
        div.field input[name="commuBno"]{
            border: none;
            color: #fff;
            padding: 0;
            height: 0;
        }
        #commuWriterTitle{
            padding: 0 0 0 2.5%;
            font-size: x-small;
            width:15%;
        }
        div.field input[name="commuWriter"]{
            border: none;
            padding:0 0 0 1.5%;
            width:20%;
            margin: 0;
        }
        div.field input[name="commuTitle"]{
            border: none;
            font-size: large;
            font-weight: bold;
        }
        #boardWriterArea{
            display: flex;
        }

    </style>
</head>
<body class="is-preload">
<!--header 위치-->
<header>
    <div id="main_header"></div>
</header>
<!--<section id="communityBanner">
    <img src="/images/shopBannerAd.png">
</section>-->
<!-- Main -->
<div id="main">
    <div class="wrapper">
        <div class="inner">

            <header class="major">
                <p></p>
            </header>
            <div id="commuBoardWrapper">
                <div id="reportBoardMiddle">
                    <div id="goCommuListBtn"> <!--href="javascript:void(0)"-->
                        <div><a id="goListBtn" href="javascript:void(0)" class="button small">목록 보기</a></div>
                        <div><a href="javascript:history.go(-1)" class="button small">돌아가기</a></div>
                    </div>
                    <div class="content">
                        <div class="form">
                            <form method="post" action="/report/removeReport">
                                <div class="fields" th:object="${admin}">
                                    <!--신고 번호 : 화이트/ 안보임-->
                                    <div class="field">
                                        <input name="bno" type="text" readonly/>
                                    </div>
                                    <!--제목 공간-->
                                    <div id="boardTitleArea">
                                        <div class="field">
                                            <input name="title" type="text" th:field="*{commuTitle}" readonly/>
                                        </div>
                                        <div class="field" id="boardWriterArea">
                                            <h4 id="commuWriterTitle">신고자 :</h4>
                                            <input name="writer" type="text" th:field="*{sessionId}" readonly/>
                                        </div>
                                    </div>
                                    <!--글 내용-->
                                    <div class="field" id="content" th:value="*{reportContent}">
                                    </div>
                                </div>
                                <ul class="actions special">
                                    <li>
                                        <input type="button" class="button" value="수정" onclick="goUpdate()"/>
                                        <input type="submit" class="button" value="삭제"/>
                                    </li>
                                </ul>
                                <!--댓글-->
                                <a href="javascript:void(0)" class="register button primary small" style="width: 100%">댓글 등록</a>
                                <div style="display: none" class="register-form">
                                    <ul class="icons">
                                        <li style="display: block">
                                            <span class="icon solid fa-envelope"></span>
                                            <strong>댓글</strong>
                                        </li>
                                    </ul>
                                    <div>
                                        <input type="text" name="replier" placeholder="Replier" style="border: none;"> <!--th:field="${sessionId}" readonly>-->
                                    </div>
                                    <div>
                                        <textarea rows="6" name="reply" placeholder="댓글을 남겨보세요" style="resize: none"></textarea>
                                    </div>
                                    <div style="text-align: right">
                                        <a href="javascript:void(0)" class="finish button primary small">등록</a>
                                        <a href="javascript:void(0)" class="cancel button primary small">취소</a>
                                    </div>
                                </div>
                                <ul class="replies"></ul>
                            </form>
                            <div class="paging" style="text-align: center"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<footer>
    <div id="main_footer"></div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.dropotron.min.js"></script>
<script src="/js/browser.min.js"></script>
<script src="/js/breakpoints.min.js"></script>
<script src="/js/util.js"></script>
<script src="/js/reply.js"></script>
<script src="/js/headerfooter.js"></script>
<script src="/js/weather.js"></script>
</body>
<script th:inline="javascript">
    let commuBno = [[${admin.getCommuBno()}]];
    let paging = [[${reportCriteria.listLink}]];
    let replyUL = $("ul.replies");
    let pageNum = 1;

    //목록보러 가기
    $("a#goList").on("click", function(){
        location.href = "/report/reportList" + paging;
    });


    //가져온 글에 html태그 인식 시키기
    let content = document.querySelector("#content");
    content.innerHTML += [[${admin.getReportContent}]];
    /*###################################################댓글###########################################################*/
    /*댓글 영역의 첫 페이지를 항상 보여준다*/
    showList(pageNum);
    /*댓글 등록 버튼 클릭시, 댓글 작성폼 보여주기*/
    $(".register").on("click", function(e){
        e.preventDefault();
        $(".register-form").show();
        $(this).hide();
    })

    /*댓글 취소 버튼 클릭시 댓글 작성폼 숨기기*/
    $(".cancel").on("click", function(e){
        e.preventDefault();
        $("input[name='replier']").val("");
        $("textarea[name='reply']").val("");
        $(".register-form").hide();
        $(".register").show();
    })

    /*댓글 등록*/
    $(".finish").on("click", function(e){
        e.preventDefault();
        let replier = $("input[name='replier']").val();
        let reply = $("textarea[name='reply']").val();

        if(!replier || !reply){return;}

        commuReplyService.add({commuBno:commuBno, commuReply:reply, commuReplier:replier},
            function(result){
                alert(result);
                $("input[name='replier']").val("");
                $("textarea[name='reply']").val("");
                $(".register-form").hide();
                $(".register").show();
                showList(pageNum);
            }
        )
    });

    //목록보러 가기
    $("a#goList").on("click", function(){
        location.href = "/report/reportList" + paging;
    });

    //===================================================================================================
    /*댓글 페이징 처리*/
    function showReplyPage(replyCnt){
        let endNum = Math.ceil(pageNum / 10.0) * 10;
        let startNum = endNum - 9;
        let realEnd = Math.ceil(replyCnt / 10.0);
        let divTag = $(".paging");
        let str = "";

        if(endNum > realEnd){
            endNum = realEnd;
        }

        let prev = startNum != 1;
        let next = endNum * 10 < replyCnt;

        //917px 까지
        if(matchMedia("screen and (max-width:918px)").matches){
            if(pageNum > 1){
                str += "<a class='changePage' href='" + (pageNum - 1) + "'><code>&lt;</code></a>"
            }
            str += "<code>" + pageNum + "</code>";
            if(pageNum < realEnd){
                str += "<a class='changePage' href='" + (pageNum + 1) + "'><code>&gt;</code></a>"
            }

        }else{//918px 이상
            if(prev){
                str += "<a class='changePage' href='" + (startNum - 1) + "'><code>&lt;</code></a>"
            }
            for(let i=startNum; i<=endNum; i++){
                if(i == pageNum){
                    str += "<code>" + i + "</code>";
                    continue;
                }
                str += "<a class='changePage' href='" + i + "'><code>" + i + "</code></a>";
            }
            if(next){
                str += "<a class='changePage' href='" + (endNum + 1) + "'><code>&gt;</code></a>"
            }
        }
        divTag.html(str);
    }


    $("div.paging").on("click", "a.changePage", function(e){
        e.preventDefault();
        pageNum = parseInt($(this).attr("href"));
        showList(pageNum);
    });

    /*댓글 목록*/
    function showList(page){
        commuReplyService.getList({commuBno:commuBno, page:page || 1},
            function(replyCnt, list){
                if(list == null || list.length == 0){
                    replyUL.html("댓글이 없습니다.");
                    return;
                }

                //댓글 수정시
                let str = "";
                for(let i=0, len=list.length; i<len; i++){
                    str += "<hr/>"
                    str += "<li style='display: block' data-commuRno='" + list[i].commuRno + "'>"
                    str += "<strong>작성자 : " + list[i].commuReplier + "</strong>"
                    str += "<div>"
                    str += "<p class='reply" + list[i].commuRno +"'>" + list[i].commuReply + "</p>"
                    str += "</div>"
                    str += "<div style='display: flex; justify-content: end'>"
                    str += "<p style='margin: 0'><strong class='date'>" + commuReplyService.displayTime(list[i].commuReplyDate) +"</strong></p>";
                    if(list[i].commuReplyDate != list[i].commuUpdateDate){
                        str += "<p style='float: right; margin:0 0 0 3%'>수정된 날짜 : " + commuReplyService.displayTime(list[i].commuUpdateDate);
                    }
                    str += "</p></div>"
                    str += "<div style='text-align: right'><a class='modify' href='" + list[i].commuRno + "'>수정</a>"
                    str += "<a class='finish' style='display: none' href='" + list[i].commuRno + "'>수정완료</a>"
                    str += "&nbsp;&nbsp;<a class='remove' href='" + list[i].commuRno + "'>삭제</a>"
                    str += "</div></li>"
                    str += "<div class='line'></div>"
                }
                replyUL.html(str);
                showReplyPage(replyCnt);
            }
        );
    }

    let check = false; //수정 중인지 아닌지 확인하는 flag
    /*댓글 수정*/
    /*이벤트 위임 -> a.modify*/
    $(".replies").on("click", "a.modify", function(e){
        e.preventDefault();
        let rnoValue = $(this).attr("href");
        $("p.reply" + rnoValue).html("<textarea class='" + rnoValue + "'>" + $("p.reply" + rnoValue).text() + "</textarea>")
        $(this).hide(); //수정버튼 숨김

        let arFinish = $(".finish");
        for(let i=0; i<arFinish.length; i++){
            if($(arFinish[i]).attr("href") == rnoValue){
                $(arFinish[i]).show();//클릭한 댓글 번호를 수정할 수 있도록 수정 완료 버튼 보이기
                check = true;
                break;
            }
        }
    });

    /*수정 확인 버튼*/
    $(".replies").on("click", "a.finish", function(e){
        e.preventDefault();

        let rnoValue = $(this).attr("href");
        let newReply = $("." + rnoValue).val(); //새로 수정된 reply value

        if(newReply == ""){return;}

        commuReplyService.update({commuRno:rnoValue, commuReply:newReply},
            function(result){
                alert(result);
                check = false;//수정 확인이 완료되면, 수정하기 false. (수정 기능 종료)
                showList(pageNum);
            }
        )
    })

    //댓글 삭제
    $(".replies").on("click", "a.remove", function(e){
        e.preventDefault();
        let rnoValue = $(this).attr("href");
        commuReplyService.remove(rnoValue,
            function(result){
                alert(result);
                showList(pageNum);
            }
        );
    })

    /*#########################################팝업############################################*/
    /*신고하기 누르면 팝업*/
    let commuToReport = [[${commu.commuBno}]];

    console.log(commuToReport + "1");

    function popup(){
        let url = "/report/report?commuBno=" + commuToReport;
        console.log(commuToReport + "2");
        let name = "신고하기";
        let option = "width = 500, height = 500, top = 100, left = 200, location = no"
        window.open(url, name, option);
    }
</script>
</html>